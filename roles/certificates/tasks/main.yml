- name: 创建{{ etcd_pki_dir }}目录
  when: "inventory_hostname in (groups['kube_etcds'] | difference(groups['delete_etcds']))"
  file:
    name: "{{ item }}"
    state: directory
    mode: "0644"
  with_items:
    - "{{ etcd_pki_dir }}"

- name: 创建{{ k8s_pki_dir }}目录
  when: "inventory_hostname in (groups['kube_cluster'] | difference(groups['delete_etcds']) | difference(groups['delete_masters']) | difference(groups['delete_nodes']))"
  file:
    name: "{{ item }}"
    state: directory
    mode: "0644"
  with_items:
    - "{{ k8s_pki_dir }}"

- name: kubeadm 创建集群，禁用 cfssl 方式生成证书
  when: startup == 'kubeadm'
  set_fact:
    enable_cfssl_certs: false

- name: kubeadm 方式安装生成证书
  when: enable_kubeadm_certs | bool
  include_tasks: kubeadm/main.yml

- name: cfssl 生成证书，仅支持 systemctl 安装方式
  when: enable_cfssl_certs | bool
  include_tasks: cfssl/main.yml

- name: openssl 生成证书
  when: enable_openssl_certs | bool
  include_tasks: openssl/main.yml

- block:
  - name: 检查 service account 私钥是否存在
    stat:
      path: "{{ k8s_pki_dir }}/sa.key"
    register: check_sa_key

  - name: 生成 service account 公私钥证书对
    when: not check_sa_key.stat.exists
    command: "{{ item }}"
    with_items:
      - "openssl genrsa -out {{ k8s_pki_dir }}/sa.key {{ cert_key_size }}"
      - "openssl {{ cert_key_algo }} -in {{ k8s_pki_dir }}/sa.key -pubout -out {{ k8s_pki_dir }}/sa.pub"
  when: enable_openssl_certs | bool or enable_cfssl_certs | bool
  run_once: true
  delegate_to: "{{ groups['kube_masters'][0] }}"

- name: 同步证书和 kube-config 文件到各节点
  include_tasks: synchronize/main.yml
